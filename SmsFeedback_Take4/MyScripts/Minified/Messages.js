window.app=window.app||{};window.app.globalMessagesRep={};var gSelectedMessage=null;var gSelectedMessageItem=null;var gSelectedConversationID=null;var gSelectedElement=null;var gDateOfSelectedMessage=null;var gDateDisplayPattern="DD, MM d, yy";var timer;var timer_is_on=0;function generateUUID(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)});return a}function markConversationAsRead(){$(gSelectedElement).removeClass("unreadconversation");$(gSelectedElement).addClass("readconversation");window.app.selectedConversation.set({Read:true});$.getJSON("Conversations/MarkConversationAsRead",{conversationId:gSelectedConversationID},function(a){window.app.updateNrOfUnreadConversations(false)})}function resetTimer(){if(timer_is_on){clearTimeout(timer);timer_is_on=false}}function startTimer(a){if(!timer_is_on){if(!$(gSelectedElement).hasClass("readconversation")){timer=setTimeout(markConversationAsRead,a);timer_is_on=true}}}function deleteMessage(f,g,a,h){$(f).remove();var c=0;for(var e=0;e<window.app.globalMessagesRep[h].models.length;++e){var b=window.app.globalMessagesRep[h].models[e];var d=a.getTime()-b.attributes.TimeReceived.getTime();if(b.attributes.Text.trim()===g&&Math.abs(d)<100&&b.attributes.ConvID===h){c=e}}window.app.globalMessagesRep[h].remove(window.app.globalMessagesRep[h].at(c))}function convertDateTimeStringToObject(a){var c=a.substr(0,a.length-10);var e=a.substr(a.length-9,8);var b=e.substr(0,2);var d=e.substr(3,2);var f=e.substr(6,2);if(window.app.calendarCulture==="ro"){gDateDisplayPattern="DD, d MM, yy"}var g=$.datepicker.parseDate(gDateDisplayPattern,c,{dayNamesShort:$.datepicker.regional[window.app.calendarCulture].dayNamesShort,dayNames:$.datepicker.regional[window.app.calendarCulture].dayNames,monthNamesShort:$.datepicker.regional[window.app.calendarCulture].monthNamesShort,monthNames:$.datepicker.regional[window.app.calendarCulture].monthNames});g.setHours(b,d,f);return g}function getMessagePositionInRepository(e,d){var b=-1;if(window.app.globalMessagesRep[e]!=null&&window.app.globalMessagesRep[e]!=undefined){for(var c=0;c<window.app.globalMessagesRep[e].models.length;++c){var a=window.app.globalMessagesRep[e].models[c];if(a.attributes.Id===d){return c}}}return b}function setMsgWasSuccessfullySentValue(d,c,b){var a=getMessagePositionInRepository(d,c);var e=window.app.globalMessagesRep[d].at(a);if(e!=null){e.set("WasSuccessfullySent",b)}}function setMsgClientAcknowledgeValue(d,b,c){var a=getMessagePositionInRepository(d,b);var e=window.app.globalMessagesRep[d].at(a);if(e!=null){e.set("ClientAcknowledge",c)}}function fixIEDateString(a){return a.replace("UTC","GMT")}window.app.Message=Backbone.Model.extend({defaults:{From:"0752345678",To:"0751569435",Text:"defaulttext",TimeReceived:Date.now(),ConvID:1,Direction:"from",Read:false,Starred:false,IsSmsBased:false,WasSuccessfullySent:false,ClientAcknowledge:false},parse:function(c,a){c.TimeReceived=new Date(Date.UTC(c.Year,c.Month-1,c.Day,c.Hours,c.Minutes,c.Seconds));var b=cleanupPhoneNumber(c.From)+"-"+cleanupPhoneNumber(c.To);if(b===c.ConvID){b="from"}else{b="to"}if(!isNaN(c.Id)){c.WasSuccessfullySent=true}c.Direction=b;return c},idAttribute:"Id"});window.app.MessagesList=Backbone.Collection.extend({model:window.app.Message,identifier:null,url:function(){return"Messages/MessagesList"}});window.app.MessageView=Backbone.View.extend({model:window.app.Message,tagName:"div",events:{"click div.deleteMessage":"deleteMessage"},initialize:function(){this.messageTemplate=_.template($("#message-template").html()),_.bindAll(this,"render","updateView","deleteMessage");this.model.on("change",this.updateView);this.model.on("change:WasSuccessfullySent",this.render);this.model.on("change:ClientAcknowledge",this.render);return this.render},render:function(){var e=this.model;this.$el.html(this.messageTemplate(this.model.toJSON()));var d="messagefrom";var a="arrowInnerLeft";if(this.model.attributes.Direction==="to"){d="messageto";a="arrowInnerRight"}this.$el.addClass("message");this.$el.addClass(d);$(".innerExtraMenu",this.$el).addClass(a);var b=$($(this.$el).find(".checkNo"+this.model.get("Id")));var c=$(this.$el).find("div.messageMenu")[0];var f=this.$el;$(b).hide();$(c).hide();$(this.$el).hover(function(){gSelectedMessage=e.get("Text");gSelectedConversationID=e.get("ConvID");$(c).fadeIn(100);$(b).show()},function(){$(c).fadeOut(100);$(b).hide()});return this},deleteMessage:function(d){var c=this.model;var g=this.$el;d.preventDefault();var a=c.get("Text");var b=c.get("ConvID");var f=c.get("TimeReceived");if(confirm($("#confirmDeleteMessage").val()+' "'+a+'" ?')){$.ajax({url:"Messages/DeleteMessage",data:{messageText:a,convId:b,timeReceived:fixIEDateString(f.toGMTString())},success:function(i){if(i==="success"){deleteMessage(g,a,f,b)}else{if(i==="lastMessage"){var h=$(g).prev();deleteMessage(g,a,f,b);if(h.length!==0){var e=$($(h).find(".textMessage").find("span")).html().trim();var j=convertDateTimeStringToObject($($(h).find(".timeReceived")[0]).html());$.ajax({url:"Conversations/UpdateConversation",data:{convId:b,newText:e,newTextReceivedDate:j.toUTCString()},success:function(k){$(gSelectedElement).find(".spanClassText").find("span").html(e)}})}}}}})}},updateView:function(){return this}});window.app.sendMessageToClient=function(m,n,b,d,g){var a=getFromToFromConversation(n);var i=a[0];var j=a[1];var k=b.get("IsSmsBased");var l=new Date();$(document).trigger("msgReceived",{fromID:j,toID:i,convID:n,msgID:d,dateReceived:l,text:m,readStatus:true,messageIsSent:true,isSmsBased:k});var c=b.get("ClientIsSupportBot");var e=j;var f=i;if(!k){if(c){f=i+window.app.workingPointsSuffixDictionary[j]}else{f=i+"@txtfeedback.net"}e=j+window.app.workingPointsSuffixDictionary[j]}var h="";if(c){h=f}else{h=g.getWorkingPointXmppAddress(cleanupPhoneNumber(j))||g.getWorkingPointXmppAddress(cleanupPhoneNumber(i))}window.app.xmppHandlerInstance.send_reply(e,f,l,n,m,h,k,c,d)};window.app.defaultMessagesOptions={messagesRep:{},currentConversationId:""};function MessagesArea(i,e,c){var j=this;var h=$("#replyBtn");h.qtip({content:h.attr("tooltiptitle"),position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});$.extend(this,window.app.defaultMessagesOptions);this.convView=i;this.tagsArea=e;this.wpsArea=c;$("#replyBtn").click(function(){j.sendMessageTriggered()});j.limitText=function(m,l,k){if(m.val().length>k){m.val(m.val().substring(0,k))}else{l.val(k-m.val().length)}};var g=$('input[name="countdown"]');$("#limitedtextarea").keydown(function(k){if(k.which===13&&k.shiftKey){k.preventDefault();j.sendMessageTriggered();return}j.limitText($(this),g,160)});$("#limitedtextarea").keyup(function(k){j.limitText($(this),g,160)});j.sendMessageTriggered=function(){var k=$("#limitedtextarea");var l=k.val();if(window.app.selectedConversation.get("IsSmsBased")){if(window.app.canSendSmS){$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(l,j.currentConversationId,window.app.selectedConversation,generateUUID(),j.wpsArea.wpPoolView.phoneNumbersPool)}else{window.app.NotifyArea.show($("#msgMessageNotSent").val(),function(){window.location.href="mailto:contact@txtfeedback.net?subject=Increase spending limit or Buy Credit"},true)}}else{$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(l,j.currentConversationId,window.app.selectedConversation,generateUUID(),j.wpsArea.wpPoolView.phoneNumbersPool)}};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var a={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var f=new Spinner(a);var d=false;var b=Backbone.View.extend({el:$("#messagesbox"),initialize:function(){_.bindAll(this,"render","getMessages","appendMessage","appendMessageToDiv","resetViewToDefault","newMessageReceived","messageSuccessfullySent","setAcknowledgeFromClient","deleteMsgsOfAConv");this.messages=new window.app.MessagesList();this.messages.bind("reset",this.render);this.quickActionBtns=new window.app.ButtonsBarView({el:$("#quickActionBtns")})},resetViewToDefault:function(){var k=$("#noConversationSelectedMessage").val();$("#messagesbox").html('<span id="noConversationsLoaded">'+k+"</span>");$("#textareaContainer").addClass("invisible");$("#tagsContainer").addClass("invisible");j.currentConversationId="";this.quickActionBtns.setVisible(false)},getMessages:function(m){$("#messagesbox").html("");if(window.app.vouchersPanel!=null){window.app.vouchersPanel.trigger(window.app.vouchersPanel.vouchersListEvents.EVENT_CLOSE_PANEL)}var l=document.getElementById("scrollablemessagebox");f.spin(l);j.currentConversationId=m;if(j.currentConversationId in window.app.globalMessagesRep){d=false;f.stop();startTimer(3000);this.render();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}else{var k=new window.app.MessagesList();k.identifier=m;k.bind("reset",this.render);k.bind("add",this.appendMessage);d=true;k.fetch({data:{conversationId:k.identifier},success:function(){startTimer(3000);f.stop();$("#textareaContainer").removeClass("invisible");$("#textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}});window.app.globalMessagesRep[j.currentConversationId]=k;$.each(k,function(n,o){o.set("Starred",window.app.selectedConversation.get("Starred"))})}},deleteMsgsOfAConv:function(k){delete window.app.globalMessagesRep[k];this.resetViewToDefault()},render:function(){$("#messagesbox").html("");var k=this;window.app.globalMessagesRep[j.currentConversationId].each(function(l){k.appendMessageToDiv(l,d,false)});this.quickActionBtns.setVisible(true);f.stop();return this},appendMessage:function(k){if(k.get("ConvID")===j.currentConversationId){this.appendMessageToDiv(k,true,true)}},newMessageReceived:function(q,n,o,s,u,l,t){var m=new window.app.Message({Id:o,From:q,Text:u,ConvID:n,ClientDisplayName:q,ClientIsSupportBot:false,Read:l,IsSmsBased:t,TimeReceived:s});var k=getFromToFromConversation(n);var r=k[0];var p="from";if(!comparePhoneNumbers(q,r)){p="to"}m.set("Direction",p);if(window.app.globalMessagesRep[n]!==undefined){window.app.globalMessagesRep[n].add(m)}},appendMessageToDiv:function(p,m,k){var o=new window.app.MessageView({model:p});var n=o.render().el;$(this.el).append(n);if(m){$(n).hide().fadeIn("2000")}if(k){var l=$("#scrollablemessagebox");l.animate({scrollTop:l.prop("scrollHeight")},3000)}},messageSuccessfullySent:function(k){setMsgWasSuccessfullySentValue(k.convID,k.msgID,true)},setAcknowledgeFromClient:function(k){setMsgClientAcknowledgeValue(k.convID,k.msgID,true)}});this.messagesView=new b();$(document).bind("giveVoucher",function(m,n){var k=$("#limitedtextarea").val();if(k.length+n.voucherCode.length<=159){$("#limitedtextarea").attr("value",k+" "+n.voucherCode);$("input[name~='countdown']").val(160-$("#limitedtextarea").val().length)}else{$(".voucherAlert").show("slow");var l=setTimeout(function(){$(".voucherAlert").hide("slow")},5000)}});$(document).bind("conversationSelected",function(k,l){j.messagesView.getMessages(l.convID)});$(document).bind("deleteMessagesOfAConversation",function(k,l){j.messagesView.deleteMsgsOfAConv(l.convId)});$(":visible").first().bind("click",function(l,m){if(window.app.vouchersPanel!=null){var k=$(l.target);if(!(k.is(".buttonWrapper")||k.parents(".buttonWrapper").length>0)){window.app.vouchersPanel.trigger(window.app.vouchersPanel.vouchersListEvents.EVENT_CLOSE_PANEL)}}})};