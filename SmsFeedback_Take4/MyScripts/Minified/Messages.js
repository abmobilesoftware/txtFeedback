window.app=window.app||{};window.app.globalMessagesRep={};var gSelectedMessage=null;var gSelectedMessageItem=null;var gSelectedConversationID=null;var gSelectedElement=null;var gDateOfSelectedMessage=null;var gDateDisplayPattern="DD, MM d, yy";var timer;var timer_is_on=0;function markConversationAsRead(){$(gSelectedElement).removeClass("unreadconversation");$(gSelectedElement).addClass("readconversation");window.app.selectedConversation.set({Read:true});$.getJSON("Messages/MarkConversationAsRead",{conversationId:gSelectedConversationID},function(a){window.app.updateNrOfUnreadConversations(false)})}function resetTimer(){if(timer_is_on){clearTimeout(timer);timer_is_on=false}}function startTimer(a){if(!timer_is_on){if(!$(gSelectedElement).hasClass("readconversation")){timer=setTimeout(markConversationAsRead,a);timer_is_on=true}}}window.app.Message=Backbone.Model.extend({defaults:{From:"0752345678",To:"0751569435",Text:"defaulttext",TimeReceived:Date.now(),ConvID:1,Direction:"from",Read:false,Starred:false,IsSmsBased:false},parse:function(c,a){c.TimeReceived=new Date(Date.UTC(c.Year,c.Month-1,c.Day,c.Hours,c.Minutes,c.Seconds));var b=cleanupPhoneNumber(c.From)+"-"+cleanupPhoneNumber(c.To);if(b===c.ConvID){b="from"}else{b="to"}c.Direction=b;return c},idAttribute:"Id"});window.app.MessagesList=Backbone.Collection.extend({model:window.app.Message,identifier:null,url:function(){return"Messages/MessagesList"}});window.app.sendMessageToClient=function(n,o,b,d,g){var a=getFromToFromConversation(o);var j=a[0];var k=a[1];var l=b.get("IsSmsBased");var m=new Date();$(document).trigger("msgReceived",{fromID:k,toID:j,convID:o,msgID:d,dateReceived:m,text:n,readStatus:true,messageIsSent:true,isSmsBased:l});var c=b.get("ClientIsSupportBot");var e=k;var f=j;if(!l){if(c){f=j+window.app.workingPointsSuffixDictionary[k]}else{f=j+"@txtfeedback.net"}e=k+window.app.workingPointsSuffixDictionary[k]}var h="";if(c){h=f}else{h=g.getWorkingPointXmppAddress(cleanupPhoneNumber(k))||g.getWorkingPointXmppAddress(cleanupPhoneNumber(j))}window.app.xmppHandlerInstance.send_reply(e,f,m,o,n,h,l,c)};window.app.defaultMessagesOptions={messagesRep:{},currentConversationId:""};function MessagesArea(h,e,c){var j=this;stLight.options({publisher:"12345",});var g=$("#replyBtn");g.qtip({content:g.attr("tooltiptitle"),position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});$.extend(this,window.app.defaultMessagesOptions);this.convView=h;this.tagsArea=e;this.wpsArea=c;$("#conversations").selectable({filter:".conversation",selected:function(l,m){gSelectedElement=m.selected;if($(gSelectedElement).hasClass("supportConversation")){if(!$(gSelectedElement).hasClass("ui-selectedSupport")){$(gSelectedElement).addClass("ui-selectedSupport")}}else{$(gSelectedElement).parent().children(".ui-selectedSupport").removeClass("ui-selectedSupport")}resetTimer();var n=m.selected.getAttribute("conversationid");gSelectedConversationID=n;window.app.selectedConversation=j.convView.convsList.get(n);j.messagesView.getMessages(n);j.tagsArea.getTags(n)},cancel:".ignoreElementOnSelection"});$("#replyBtn").click(function(){var l=$("#limitedtextarea");window.app.receivedMsgID++;var m=l.val();$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(m,j.currentConversationId,window.app.selectedConversation,window.app.receivedMsgID,j.wpsArea.wpPoolView.phoneNumbersPool)});$("#limitedtextarea").keydown(function(m){if(m.which===13&&m.shiftKey){var l=$("#limitedtextarea");window.app.receivedMsgID++;var n=l.val();$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(n,j.currentConversationId,window.app.selectedConversation,window.app.receivedMsgID,j.wpsArea.wpPoolView.phoneNumbersPool);m.preventDefault()}});_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var k=Backbone.View.extend({model:window.app.Message,tagName:"div",messageTemplate:_.template($("#message-template").html()),initialize:function(){_.bindAll(this,"render","updateView");this.model.on("change",this.updateView);return this.render},render:function(){this.$el.html(this.messageTemplate(this.model.toJSON()));var m="messagefrom";var l="arrowInnerLeft";if(this.model.attributes.Direction==="to"){m="messageto";l="arrowInnerRight"}this.$el.addClass("message");this.$el.addClass(m);$(".innerExtraMenu",this.$el).addClass(l);return this},updateView:function(){return this}});var a={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var f=new Spinner(a);var d=false;var b=Backbone.View.extend({el:$("#messagesbox"),initialize:function(){_.bindAll(this,"render","getMessages","appendMessage","appendMessageToDiv","resetViewToDefault","newMessageReceived");this.messages=new window.app.MessagesList();this.messages.bind("reset",this.render)},resetViewToDefault:function(){var l=$("#noConversationSelectedMessage").val();$("#messagesbox").html('<span id="noConversationsLoaded">'+l+"</span>");$("#textareaContainer").addClass("invisible");$("#tagsContainer").addClass("invisible");j.currentConversationId=""},getMessages:function(n){$("#messagesbox").html("");var m=document.getElementById("scrollablemessagebox");f.spin(m);j.currentConversationId=n;if(j.currentConversationId in window.app.globalMessagesRep){d=false;f.stop();startTimer(3000);this.render();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}else{var l=new window.app.MessagesList();l.identifier=n;l.bind("reset",this.render);l.bind("add",this.appendMessage);d=true;l.fetch({data:{conversationId:l.identifier},success:function(){startTimer(3000);f.stop();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}});window.app.globalMessagesRep[j.currentConversationId]=l;$.each(l,function(o,p){p.set("Starred",window.app.selectedConversation.get("Starred"))})}},render:function(){$("#messagesbox").html("");var l=this;window.app.globalMessagesRep[j.currentConversationId].each(function(m){l.appendMessageToDiv(m,d,false)});f.stop();return this},appendMessage:function(l){if(l.get("ConvID")===j.currentConversationId){this.appendMessageToDiv(l,true,true)}},newMessageReceived:function(r,o,p,t,v,m,u){var n=new window.app.Message({Id:p,From:r,Text:v,ConvID:o,ClientDisplayName:r,ClientIsSupportBot:false,Read:m,IsSmsBased:u,TimeReceived:t});var l=getFromToFromConversation(o);var s=l[0];var q="from";if(!comparePhoneNumbers(r,s)){q="to"}n.set("Direction",q);if(window.app.globalMessagesRep[o]!==undefined){window.app.globalMessagesRep[o].add(n)}},appendMessageToDiv:function(q,n,l){var p=new k({model:q});var o=p.render().el;$(this.el).append(o);$(o).hover(function(){var s=$(this).find("div.messageMenu")[0];$(s).css("visibility","visible");if(window.app.calendarCulture=="ro"){gDateDisplayPattern="DD, d MM, yy"}gSelectedMessage=$($(this).find("div span")[0]).html();var r=$($(this).find(".timeReceived")[0]).html();gDateOfSelectedMessage=convertDateTimeStringToObject(r);gSelectedMessageItem=$(this);$(s).fadeIn(100);$(s).show()},function(){var r=$(this).find("div.messageMenu")[0];$(r).hide()});if(n){$(o).hide().fadeIn("2000")}if(l){var m=$("#scrollablemessagebox");m.animate({scrollTop:m.prop("scrollHeight")},3000)}}});this.messagesView=new b();$("div.deleteMessage").live("click",function(p){p.preventDefault();var n=gSelectedMessage.trim();var o=gSelectedConversationID;var l=gDateOfSelectedMessage;var m=gSelectedMessageItem;if(confirm($("#confirmDeleteMessage").val()+' "'+n+'" ?')){$.ajax({url:"Messages/DeleteMessage",data:{messageText:n,convId:o,timeReceived:l.toUTCString()},success:function(s){if(s=="success"){deleteMessage(m,n,l,o)}else{if(s=="lastMessage"){var r=$(m).prev();deleteMessage(m,n,l,o);if(r.length!=0){var q=$($(r).find(".textMessage").find("span")).html().trim();var t=convertDateTimeStringToObject($($(r).find(".timeReceived")[0]).html());$.ajax({url:"Messages/UpdateConversation",data:{convId:o,newText:q,newTextReceivedDate:t.toUTCString()},success:function(u){$(gSelectedElement).find(".spanClassText").find("span").html(q)}})}}}}})}})}function deleteMessage(e,f,a,g){$(e).remove();var c=0;for(i=0;i<window.app.globalMessagesRep[g].models.length;++i){var b=window.app.globalMessagesRep[g].models[i];var d=a.getTime()-b.attributes.TimeReceived.getTime();if(b.attributes.Text.trim()==f&&Math.abs(d)<100&&b.attributes.ConvID==g){c=i}}window.app.globalMessagesRep[g].remove(window.app.globalMessagesRep[g].at(c))}function limitText(c,b,a){if(c.value.length>a){c.value=c.value.substring(0,a)}else{b.value=a-c.value.length}}function convertDateTimeStringToObject(a){var c=a.substr(0,a.length-10);var e=a.substr(a.length-9,8);var b=e.substr(0,2);var d=e.substr(3,2);var f=e.substr(6,2);var g=$.datepicker.parseDate(gDateDisplayPattern,c,{dayNamesShort:$.datepicker.regional[window.app.calendarCulture].dayNamesShort,dayNames:$.datepicker.regional[window.app.calendarCulture].dayNames,monthNamesShort:$.datepicker.regional[window.app.calendarCulture].monthNamesShort,monthNames:$.datepicker.regional[window.app.calendarCulture].monthNames});g.setHours(b,d,f);return g};