window.app=window.app||{};window.app.globalMessagesRep={};window.app.receivedMsgID=12345;var gSelectedMessage=null;var gSelectedConversationID=null;var gSelectedElement=null;var timer;var timer_is_on=0;function markConversationAsRead(){$(gSelectedElement).removeClass("unreadconversation");$(gSelectedElement).addClass("readconversation");window.app.selectedConversation.set({Read:true});$.getJSON("Messages/MarkConversationAsRead",{conversationId:gSelectedConversationID},function(a){window.app.updateNrOfUnreadConversations(false)})}function resetTimer(){if(timer_is_on){clearTimeout(timer);timer_is_on=false}}function startTimer(a){if(!timer_is_on){if(!$(gSelectedElement).hasClass("readconversation")){timer=setTimeout(markConversationAsRead,a);timer_is_on=true}}}window.app.Message=Backbone.Model.extend({defaults:{From:"0752345678",To:"0751569435",Text:"defaulttext",TimeReceived:Date.now(),ConvID:1,Direction:"from",Read:false,Starred:false,IsSmsBased:false},parse:function(c,a){c.TimeReceived=(new Date(Date.UTC(c.Year,c.Month-1,c.Day,c.Hours,c.Minutes,c.Seconds)));var b=cleanupPhoneNumber(c.From)+"-"+cleanupPhoneNumber(c.To);if(b===c.ConvID){b="from"}else{b="to"}c.Direction=b;return c},idAttribute:"Id"});window.app.MessagesList=Backbone.Collection.extend({model:window.app.Message,identifier:null,url:function(){return"Messages/MessagesList"}});window.app.handleIncommingMessage=function(f,g){window.app.receivedMsgID++;var q;if(window.DOMParser){var a=new DOMParser();q=a.parseFromString(f,"text/xml")}else{q=new ActiveXObject("Microsoft.XMLDOM");q.async=false;q.loadXML(f)}var l=q.getElementsByTagName("msg")[0];if(l!==undefined){var c=l.getElementsByTagName("from")[0].textContent;var b=l.getElementsByTagName("to")[0].textContent;var j=cleanupPhoneNumber(b);var k=cleanupPhoneNumber(c);var p;p=window.app.workingPointsSuffixDictionary[j]||window.app.workingPointsSuffixDictionary[k];var i=isWorkingPoint(c,p);var m=l.getElementsByTagName("datesent")[0].textContent;var d=l.getElementsByTagName("sms")[0].textContent;var o=false;if(d==="true"){o=true}var e;if(i&&g){e=buildConversationID(k,j)}else{e=l.getElementsByTagName("convID")[0].textContent}var h=l.getElementsByTagName("body")[0].textContent;var n=false;window.app.receivedMsgID++;$(document).trigger("msgReceived",{fromID:k,toID:j,convID:e,msgID:window.app.receivedMsgID,dateReceived:m,text:h,readStatus:n,isSmsBased:o})}};window.app.sendMessageToClient=function(m,n,b,d,g){var a=getFromToFromConversation(n);var i=a[0];var j=a[1];var k=b.get("IsSmsBased");var l=new Date();$(document).trigger("msgReceived",{fromID:j,toID:i,convID:n,msgID:d,dateReceived:l,text:m,readStatus:true,messageIsSent:true,isSmsBased:k});var c=b.get("ClientIsSupportBot");var e=j;var f=i;if(!k){if(c){f=i+window.app.workingPointsSuffixDictionary[j]}else{f=i+"@txtfeedback.net"}e=j+window.app.workingPointsSuffixDictionary[j]}var h="";if(c){h=f}else{h=g.getWorkingPointXmppAddress(cleanupPhoneNumber(j))||g.getWorkingPointXmppAddress(cleanupPhoneNumber(i))}window.app.xmppHandlerInstance.send_reply(e,f,l,n,m,h,k,c)};window.app.defaultMessagesOptions={messagesRep:{},currentConversationId:""};function MessagesArea(h,e,c){var i=this;var g=$("#replyBtn");g.qtip({content:g.attr("tooltiptitle"),position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});$.extend(this,window.app.defaultMessagesOptions);this.convView=h;this.tagsArea=e;this.wpsArea=c;$("#conversations").selectable({filter:".conversation",selected:function(k,l){gSelectedElement=l.selected;if($(gSelectedElement).hasClass("supportConversation")){if(!$(gSelectedElement).hasClass("ui-selectedSupport")){$(gSelectedElement).addClass("ui-selectedSupport")}}else{$(gSelectedElement).parent().children(".ui-selectedSupport").removeClass("ui-selectedSupport")}resetTimer();var m=l.selected.getAttribute("conversationid");gSelectedConversationID=m;window.app.selectedConversation=i.convView.convsList.get(m);i.messagesView.getMessages(m);i.tagsArea.getTags(m)},cancel:".conversationStarIconImg"});$("#replyBtn").click(function(){var k=$("#limitedtextarea");window.app.receivedMsgID++;var l=k.val();$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(l,i.currentConversationId,window.app.selectedConversation,window.app.receivedMsgID,i.wpsArea.wpPoolView.phoneNumbersPool)});$("#limitedtextarea").keydown(function(l){if(l.which===13&&l.shiftKey){var k=$("#limitedtextarea");window.app.receivedMsgID++;var m=k.val();$("#replyToMessageForm")[0].reset();window.app.sendMessageToClient(m,i.currentConversationId,window.app.selectedConversation,window.app.receivedMsgID,i.wpsArea.wpPoolView.phoneNumbersPool);l.preventDefault()}});_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var j=Backbone.View.extend({model:window.app.Message,tagName:"div",messageTemplate:_.template($("#message-template").html()),initialize:function(){_.bindAll(this,"render","updateView");this.model.on("change",this.updateView);return this.render},render:function(){this.$el.html(this.messageTemplate(this.model.toJSON()));var m="messagefrom";var k="arrowInnerLeft";var n="extraMenuWrapperLeft";if(this.model.attributes.Direction==="to"){m="messageto";k="arrowInnerRight";n="extraMenuWrapperRight"}this.$el.addClass("message");this.$el.addClass(m);$(".innerExtraMenu",this.$el).addClass(k);$(".extraMenuWrapper",this.$el).addClass(n);var l=$("div.sendEmailButton img",this.$el);setTooltipOnElement(l,l.attr("tooltiptitle"),"dark");return this},updateView:function(){return this}});var a={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var f=new Spinner(a);var d=false;var b=Backbone.View.extend({el:$("#messagesbox"),initialize:function(){_.bindAll(this,"render","getMessages","appendMessage","appendMessageToDiv","resetViewToDefault","newMessageReceived");this.messages=new window.app.MessagesList();this.messages.bind("reset",this.render)},resetViewToDefault:function(){var k=$("#noConversationSelectedMessage").val();$("#messagesbox").html('<span id="noConversationsLoaded">'+k+"</span>");$("#textareaContainer").addClass("invisible");$("#tagsContainer").addClass("invisible");i.currentConversationId=""},getMessages:function(m){$("#messagesbox").html("");var l=document.getElementById("scrollablemessagebox");f.spin(l);i.currentConversationId=m;if(i.currentConversationId in window.app.globalMessagesRep){d=false;f.stop();startTimer(3000);this.render();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}else{var k=new window.app.MessagesList();k.identifier=m;k.bind("reset",this.render);k.bind("add",this.appendMessage);d=true;k.fetch({data:{conversationId:k.identifier},success:function(){startTimer(3000);f.stop();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}});window.app.globalMessagesRep[i.currentConversationId]=k;$.each(k,function(n,o){o.set("Starred",window.app.selectedConversation.get("Starred"))})}},render:function(){$("#messagesbox").html("");var k=this;window.app.globalMessagesRep[i.currentConversationId].each(function(l){k.appendMessageToDiv(l,d,false)});f.stop();return this},appendMessage:function(k){if(k.get("ConvID")===i.currentConversationId){this.appendMessageToDiv(k,true,true)}},newMessageReceived:function(q,n,o,s,u,l,t){var m=new window.app.Message({Id:o,From:q,Text:u,ConvID:n,ClientDisplayName:q,ClientIsSupportBot:false,Read:l,IsSmsBased:t});var k=getFromToFromConversation(n);var r=k[0];var p="from";if(!comparePhoneNumbers(q,r)){p="to"}m.set("Direction",p);m.set("TimeReceived",new Date(Date.parse(s)));if(window.app.globalMessagesRep[n]!==undefined){window.app.globalMessagesRep[n].add(m)}},appendMessageToDiv:function(p,m,k){var o=new j({model:p});var n=o.render().el;$(this.el).append(n);$(n).hover(function(){var q=$(this).find("div.extramenu")[0];gSelectedMessage=$($(this).find("div span")[0]).html();$(q).show()},function(){var q=$(this).find("div.extramenu")[0];$(q).hide()});if(m){$(n).hide().fadeIn("2000")}if(k){var l=$("#scrollablemessagebox");l.animate({scrollTop:l.prop("scrollHeight")},3000)}}});this.messagesView=new b()}function limitText(c,b,a){if(c.value.length>a){c.value=c.value.substring(0,a)}else{b.value=a-c.value.length}};