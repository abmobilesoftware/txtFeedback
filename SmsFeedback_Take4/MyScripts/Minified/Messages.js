"use strict";window.app=window.app||{};var gSelectedMessage=null;var gSelectedConversationID=null;var gSelectedElement=null;var timer;var timer_is_on=0;function markConversationAsRead(){$(gSelectedElement).removeClass("unreadconversation");$(gSelectedElement).addClass("readconversation");app.selectedConversation.set({Read:true});$.getJSON("Messages/MarkConversationAsRead",{conversationId:gSelectedConversationID},function(a){app.updateNrOfUnreadConversations(false);console.log("MarkConversationAsRead done")})}function resetTimer(){if(timer_is_on){clearTimeout(timer);timer_is_on=false}}function startTimer(a){if(!timer_is_on){if(!$(gSelectedElement).hasClass("readconversation")){timer=setTimeout(markConversationAsRead,a);timer_is_on=true}}}window.app.Message=Backbone.Model.extend({defaults:{From:"0752345678",To:"0751569435",Text:"defaulttext",TimeReceived:Date.now(),ConvID:1,Direction:"from",Read:false,Starred:false},parse:function(c,a){var d=c.TimeReceived.substring(6,19);c.TimeReceived=(new Date(Date.UTC(c.Year,c.Month-1,c.Day,c.Hours,c.Minutes,c.Seconds)));var b=cleanupPhoneNumber(c.From)+"-"+cleanupPhoneNumber(c.To);if(b===c.ConvID){b="from"}else{b="to"}c.Direction=b;return c},idAttribute:"Id"});window.app.MessagesList=Backbone.Collection.extend({model:app.Message,identifier:null,url:function(){return"Messages/MessagesList"}});window.app.defaultMessagesOptions={messagesRep:{},currentConversationId:""};function MessagesArea(h,f){var i=this;$("#replyBtn").qtip({content:{text:false},position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});$.extend(this,app.defaultMessagesOptions);this.convView=h;this.tagsArea=f;$("#conversations").selectable({filter:".conversation",selected:function(k,l){gSelectedElement=l.selected;resetTimer();var m=l.selected.getAttribute("conversationid");gSelectedConversationID=m;app.selectedConversation=i.convView.convsList.get(m);i.messagesView.getMessages(m);i.tagsArea.getTags(m)},cancel:".conversationStarIconImg"});var b=412536;var c=function(){var k=$("#limitedtextarea");b++;var n=k.val();var l=getFromToFromConversation(i.currentConversationId);var p=l[0];var o=l[1];$.getJSON("Messages/SendMessage",{from:o,to:p,convId:i.currentConversationId,text:n},function(q){console.log(q)});var m=new Date();$(document).trigger("msgReceived",{fromID:o,toID:p,convID:i.currentConversationId,msgID:b,dateReceived:m,text:n,readStatus:false,messageIsSent:true});$("#replyToMessageForm")[0].reset()};$("#replyBtn").click(function(){c()});$("#limitedtextarea").keydown(function(k){if(k.which===13&&k.shiftKey){c();k.preventDefault()}});_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var j=Backbone.View.extend({model:app.Message,tagName:"div",messageTemplate:_.template($("#message-template").html()),initialize:function(){_.bindAll(this,"render","updateView");this.model.on("change",this.updateView);return this.render},render:function(){this.$el.html(this.messageTemplate(this.model.toJSON()));var n="messagefrom";var l="arrowFrom";var m="arrowInnerFrom";var k="arrowInnerLeft";var o="extraMenuWrapperLeft";if(this.model.attributes.Direction==="to"){n="messageto";l="arrowTo";m="arrowInnerTo";k="arrowInnerRight";o="extraMenuWrapperRight"}this.$el.addClass("message");this.$el.addClass(n);$(".arrow",this.$el).addClass(l);$(".arrowInner",this.$el).addClass(m);$(".innerExtraMenu",this.$el).addClass(k);$(".extraMenuWrapper",this.$el).addClass(o);$("div.sendEmailButton img",this.$el).qtip({content:{text:false},style:"dark"});return this},updateView:function(){return this}});var a={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var g=new Spinner(a);var e=false;var d=Backbone.View.extend({el:$("#messagesbox"),initialize:function(){_.bindAll(this,"render","getMessages","appendMessage","appendMessageToDiv","resetViewToDefault","newMessageReceived");this.messages=new app.MessagesList();this.messages.bind("reset",this.render)},resetViewToDefault:function(){$("#messagesbox").html($("#noConversationSelectedMessage").val());$("#textareaContainer").addClass("invisible");$("#tagsContainer").addClass("invisible");i.currentConversationId=""},getMessages:function(m){console.log("getting conversations with id:"+m);$("#messagesbox").html("");var l=document.getElementById("scrollablemessagebox");g.spin(l);i.currentConversationId=m;if(i.currentConversationId in app.globalMessagesRep){e=false;g.stop();startTimer(3000);this.render();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}else{var k=new app.MessagesList();k.identifier=m;k.bind("reset",this.render);k.bind("add",this.appendMessage);e=true;k.fetch({data:{conversationId:k.identifier},success:function(){startTimer(3000);g.stop();$("#textareaContainer").removeClass("invisible");$("textareaContainer").fadeIn("slow");$("#tagsContainer").removeClass("invisible");$("#tagsContainer").fadeIn("slow")}});app.globalMessagesRep[i.currentConversationId]=k;$.each(k,function(n,o){o.set("Starred",app.selectedConversation.get("Starred"))})}},render:function(){$("#messagesbox").html("");var k=this;app.globalMessagesRep[i.currentConversationId].each(function(l){k.appendMessageToDiv(l,e,false)});g.stop();return this},appendMessage:function(k){if(k.get("ConvID")===i.currentConversationId){console.log("Adding new message: "+k.get("Text"));this.appendMessageToDiv(k,true,true)}},newMessageReceived:function(p,m,n,r,s){console.log("new message received: "+s+" with ID:"+n);var l=new app.Message({Id:n});var k=getFromToFromConversation(i.currentConversationId);var q=k[0];var o="from";if(!comparePhoneNumbers(p,q)){o="to"}l.set("Direction",o);l.set("From",p);l.set("ConvID",m);l.set("Text",s);l.set("TimeReceived",new Date(Date.parse(r)));if(app.globalMessagesRep[m]!==undefined){app.globalMessagesRep[m].add(l)}},appendMessageToDiv:function(p,m,k){var o=new j({model:p});var n=o.render().el;$(this.el).append(n);$(n).hover(function(){var q=$(this).find("div.extramenu")[0];gSelectedMessage=$($(this).find("div span")[0]).html();$(q).show()},function(){var q=$(this).find("div.extramenu")[0];$(q).hide()});if(m){$(n).hide().fadeIn("2000")}if(k){var l=$("#scrollablemessagebox");l.animate({scrollTop:l.prop("scrollHeight")},3000)}}});this.messagesView=new d()}function limitText(c,b,a){if(c.value.length>a){c.value=c.value.substring(0,a)}else{b.value=a-c.value.length}};