"use strict";window.app=window.app||{};window.app.selectedConversation={};window.app.globalMessagesRep={};window.app.defaultNrOfConversationsToDisplay=2;window.app.defaultNrOfConversationsToSkip=0;window.app.cummulativeSkip=window.app.defaultNrOfConversationsToSkip;window.app.Conversation=Backbone.Model.extend({defaults:{TimeUpdated:Date.now(),Read:false,Text:"some data",From:"defaultNumber",To:"defaultRecipient",Starred:false,ClientDisplayName:"defaultClient",ClientIsSupportBot:false},parse:function(b,a){b.TimeUpdated=b.TimeReceived;return b},idAttribute:"ConvID"});window.app.ConversationsList=Backbone.Collection.extend({model:app.Conversation,convID:null,url:function(){return"Messages/ConversationsList"}});$(function(){window.app=window.app||{};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};window.app.ConversationView=Backbone.View.extend({model:app.Conversation,tagName:"div",conversationTemplate:_.template($("#conversation-template").html()),self:this,initialize:function(){_.bindAll(this,"render","updateFavouritesIcon");this.model.on("change:Starred",this.updateFavouritesIcon);this.model.on("change:Read",this.render);return this.render},render:function(){var d=this;this.$el.html(this.conversationTemplate(this.model.toJSON()));var a="unreadconversation";if(this.model.attributes.Read===true){a="readconversation"}var c="normalConversation";if(this.model.attributes.ClientIsSupportBot){c="supportConversation"}this.$el.addClass("conversation");this.$el.addClass(a);this.$el.addClass(c);$(this.el).attr("conversationId",this.model.attributes.ConvID);var b=$(".conversationStarIcon img",this.$el);setTooltipOnElement(b,b.attr("tooltiptitle"),"dark");$(".conversationStarIconImg",this.$el).bind("click",function(h){h.preventDefault();var i=$(this).parents(".conversation").attr("conversationId");var f=false;if(app.globalMessagesRep[i]!==undefined){app.globalMessagesRep[i].each(function(e){e.set("Starred",!e.attributes.Starred);f=e.attributes.Starred})}var g=d.model.get("Starred");d.model.set("Starred",!g);$.getJSON("Messages/ChangeStarredStatusForConversation",{conversationId:i,newStarredStatus:!g},function(e){})});return this},updateFavouritesIcon:function(){var a=$(".conversationStarIcon img",this.$el);a.qtip("destroy");if(this.model.get("Starred")){a.attr("src",window.app.domainName+"/Content/images/star-selected_orange.svg")}else{a.attr("src",window.app.domainName+"/Content/images/star.svg")}setTooltipOnElement(a,a.attr("tooltiptitle"),"dark")}})});function ConversationArea(f,d){var a=this;var e={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var h=new Spinner(e);var g={lines:13,length:7,width:4,radius:4,rotate:0,color:"#fff",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var b=new Spinner(g);var c=Backbone.View.extend({el:$("#conversations"),initialize:function(){this.filters=f;this.workingPoints=d;_.bindAll(this,"render","getConversations","getAdditionalConversations","addConversationWithEffect","addConversationBasicEffect","updateConversation","newMessageReceived","gatherFilterOptions");this.convsList=new app.ConversationsList();this.convsList.bind("reset",this.render);this._convViews=[];this.addConversationAsNewElement=true;this.refreshsInProgress=0},getConversations:function(){this._convViews=[];var j=this;app.cummulativeSkip=app.defaultNrOfConversationsToSkip;this.refreshsInProgress++;var k=document.getElementById("scrollableconversations");$("#loadMoreConversations").hide();$("#conversations").html("");h.spin(k);var i=this.gatherFilterOptions();this.convsList.fetch({data:i,traditional:true,success:function(l){if(j.refreshsInProgress<=1){h.stop()}if(app.firstCall){app.updateNrOfUnreadConversations(false);app.firstCall=false}app.requestIndex++}})},gatherFilterOptions:function(){var n={};var m=[];if(this.filters.tagFilteringEnabled){m=this.filters.tagsForFiltering}var o=this.filters.starredFilteringEnabled;var i=this.filters.supportFilteringEnabled;var j=this.workingPoints.checkedPhoneNumbersArray;var k,p;if(this.filters.dateFilteringEnabled){k=this.filters.startDate;p=this.filters.endDate}var l=this.filters.unreadFilteringEnabled;var q=app.defaultNrOfConversationsToDisplay;var r=app.cummulativeSkip;n.onlyFavorites=o;n.tags=m;n.workingPointsNumbers=j;n.startDate=k;n.endDate=p;n.onlyUnread=l;n.skip=r;n.top=q;n.requestIndex=app.requestIndex;n.popUpSupport=i;return n},getAdditionalConversations:function(){var k=document.getElementById("loadMoreConversations");$(k).removeClass("readable");$(k).addClass("unreadable");b.spin(k);app.cummulativeSkip=this.convsList.length;var i=this.gatherFilterOptions();var j=this;$.ajax({url:"Messages/ConversationsList",data:i,traditional:true,success:function(m,n,l){b.stop();$(k).removeClass("unreadable");$(k).addClass("readable");$.each(m,function(){var o=new app.Conversation({From:$(this).attr("From"),ConvID:$(this).attr("ConvID"),TimeReceived:$(this).attr("TimeReceived"),Text:$(this).attr("Text"),Read:$(this).attr("Read"),To:$(this).attr("To"),Starred:$(this).attr("Starred"),ClientDisplayName:$(this).attr("ClientDisplayName"),ClientIsSupportBot:$(this).attr("ClientIsSupportBot")});j.convsList.add(o,{silent:true});j.addConversationBasicEffect(o,false)});if(m.length===0||m.length<app.defaultNrOfConversationsToDisplay){$(k).hide("slow")}}})},render:function(){this._rendered=true;this.refreshsInProgress--;if(this.refreshsInProgress===0){var j=$("#conversations");j.html("");var i=this;this.convsList.each(function(k){i.addConversationBasicEffect(k)})}},addConversationWithEffect:function(l,k,j){if(k===null){k=true}if(j===null){j=false}var i=this.addConversationNoEffect(l,k);var m=300;if(j){if(l.ClientIsSupportBot){$(i).addClass("ui-selectedSupport")}else{$(i).addClass("ui-selected")}gSelectedElement=i;resetTimer();startTimer(3000)}$(i).hide().fadeIn(m).fadeOut(m).fadeIn(m).fadeOut(m).fadeIn(m).fadeOut(m).fadeIn(m)},addConversationBasicEffect:function(k,j){if(j===null){j=true}var i=this.addConversationNoEffect(k,j);$(i).hide().fadeIn("slow")},addConversationNoEffect:function(m,l){var j=new app.ConversationView({model:m});this._convViews.push(j);var k=j.render().el;if(l){$(this.el).prepend(k)}else{$(this.el).append(k)}var i=this;m.on("change",function(n){if(n.hasChanged("Read")&&n.get("Read")){}else{if(n.hasChanged("Starred")){}else{i.updateConversation(n)}}});if(this.convsList.models.length>=app.defaultNrOfConversationsToDisplay){$("#loadMoreConversations").show("slow")}return k},updateConversation:function(i){var j=this;var l=_(this._convViews).select(function(n){return n.model.get("ConvID")===i.get("ConvID")})[0];if(l!==undefined&&l!==null){this._convViews=_(this._convViews).without(l);if(this._rendered){var m=false;if(gSelectedElement===l.el){m=true}var k=$(l.el);k.fadeOut("slow",function(){k.remove();i.off("change");j.addConversationWithEffect(i,true,m)})}}},newMessageReceived:function(k,i,o,j,m){var l=false;var n=a.convsView.convsList.get(o);if(n){n.set({Text:m},{silent:true});n.set({Read:l},{silent:true});n.set("To",i);n.set("From",k)}else{if(!a.convsView.filters.IsFilteringEnabled()){var p=new app.Conversation({From:k,To:i,ConvID:o,TimeReceived:j,Text:m});a.convsView.convsList.add(p);a.convsView.addConversationWithEffect(p,true,false)}}}});$("#loadMoreConversations").bind("click",function(i){a.convsView.getAdditionalConversations()});this.convsView=new c()};