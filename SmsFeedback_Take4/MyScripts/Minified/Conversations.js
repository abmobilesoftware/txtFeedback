window.app=window.app||{};window.app.selectedConversation={};window.app.isInConversationsTab=true;window.app.defaultNrOfConversationsToDisplay=10;window.app.defaultNrOfConversationsToSkip=0;window.app.cummulativeSkip=window.app.defaultNrOfConversationsToSkip;window.app.Conversation=Backbone.Model.extend({events:{EVENT_SELECTED_STATE:"updateSelectStateEvent"},defaults:{TimeUpdated:Date.now(),Read:false,Text:"some data",From:"defaultDirectionNumber",To:"defaultRecipient",ConvID:"defaultConversationID",Starred:false,ClientDisplayName:"defaultClient",ClientIsSupportBot:false,IsSmsBased:false,RequestSelect:false},parse:function(b,a){b.TimeUpdated=b.TimeReceived;if(b.IsSmsBased==="false"||b.IsSmsBased===false){b.IsSmsBased=false}else{b.IsSmsBased=true;b.ClientDisplayName=b.From.substring(0,b.From.length-4)+"...."}return b},toggleStarred:function(){var a=this;a.set("Starred",!a.get("Starred"));$.getJSON("Conversations/ChangeStarredStatusForConversation",{conversationId:this.get("ConvID"),newStarredStatus:this.get("Starred")},function(b){if(b!=="Update successful"){a.set("Starred",!a.get("Starred"))}}).fail(function(){a.set("Starred",!a.get("Starred"))})},idAttribute:"ConvID"});window.app.ConversationsList=Backbone.Collection.extend({model:window.app.Conversation,convID:null,url:"Conversations/Delete",initialize:function(){this.on("change:RequestSelect",this.updateConvSelectedState)},methodUrl:{read:"Conversations/ConversationsList","delete":"Conversations/Delete"},sync:function(d,c,a){if(c.methodUrl&&c.methodUrl[d]){a=a||{};a.url=c.methodUrl[d]}var b=(d==="delete")?"create":d;Backbone.sync(b,c,a)},updateConvSelectedState:function(a){if(a.changed.RequestSelect){_.each(this.models,function(b){b.trigger(b.events.EVENT_SELECTED_STATE)})}}});$(function(){window.app=window.app||{};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{%([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};$("#convOverlay").hide();var b={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var a=new Spinner(b);window.app.ConversationView=Backbone.View.extend({events:{"click .star":"favoriteStarClicked","click .conversation":"conversationClicked"},model:window.app.Conversation,tagName:"div",conversationTemplate:_.template($("#conversation-template").html()),self:this,initialize:function(){_.bindAll(this,"render","updateFavouritesIcon","unrender","favoriteStarClicked","conversationClicked","updateSelectedState");this.transition=new Transition(document.getElementById("scrollableconversations"),$("#convOverlay"));this.render();this.model.on("change:Starred",this.updateFavouritesIcon);this.model.on("change:Read",this.render);this.model.on(this.model.events.EVENT_SELECTED_STATE,this.updateSelectedState);this.domElements={STAR:$(".star",this.$el),STARRED:$(".starred",this.$el),UNSTARRED:$(".unstarred",this.$el)}},render:function(){var e=this;this.$el.html(this.conversationTemplate(this.model.toJSON()));var c=$(".deleteConv img",this.$el);setTooltipOnElement(c,c.attr("tooltiptitle"),"dark");$(".deleteConvImg",this.$el).bind("click",function(f){f.preventDefault();if(confirm($("#confirmDeleteConversation").val()+' "'+e.model.get("ClientDisplayName")+'" ?')){e.transition.startTransition();e.model.destroy({wait:true,success:function(i,g,h){e.unrender();e.transition.endTransition();$(document).trigger("deleteMessagesOfAConversation",{convId:i.get("ConvID")})},error:function(h,i,g){e.transition.endTransition()}})}});var d=$(".deleteConv",this.$el);if(d!==undefined){$(this.$el).hover(function(){$(d).fadeIn(100)},function(){$(d).fadeOut(100)})}return this},unrender:function(){$(this.el).remove()},updateFavouritesIcon:function(){if(this.model.get("Starred")){$(".starred",this.$el).show();$(".unstarred",this.$el).hide()}else{$(".starred",this.$el).hide();$(".unstarred",this.$el).show()}},favoriteStarClicked:function(c){c.preventDefault();this.model.toggleStarred()},conversationClicked:function(c){c.preventDefault();if(!$(c.target).hasClass("star")){this.model.set("RequestSelect",true);gSelectedElement=this.$el;resetTimer();gSelectedConversationID=this.model.get("ConvID");window.app.selectedConversation=this.model;$(document).trigger("conversationSelected",{convID:gSelectedConversationID})}},updateSelectedState:function(){if(this.model.get("RequestSelect")){$(".conversation",this.$el).addClass("ui-selected");this.model.set("RequestSelect",false)}else{$(".conversation",this.$el).removeClass("ui-selected")}}})});function ConversationArea(f,d){var a=this;var e={lines:13,length:7,width:4,radius:10,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var h=new Spinner(e);var g={lines:13,length:7,width:4,radius:4,rotate:0,color:"#fff",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var b=new Spinner(g);var c=Backbone.View.extend({el:$("#conversations"),initialize:function(){this.filters=f;this.workingPoints=d;_.bindAll(this,"render","getConversations","getAdditionalConversations","addConversationWithEffect","addConversationBasicEffect","updateConversation","newMessageReceived","gatherFilterOptions");this.convsList=new window.app.ConversationsList();this.convsList.bind("reset",this.render);this._convViews=[];this.addConversationAsNewElement=true;this.refreshsInProgress=0},getConversations:function(){this._convViews=[];var j=this;window.app.cummulativeSkip=window.app.defaultNrOfConversationsToSkip;this.refreshsInProgress++;var k=document.getElementById("scrollableconversations");$("#loadMoreConversations").hide();$("#conversations").html("");h.spin(k);var i=this.gatherFilterOptions();this.convsList.fetch({data:i,traditional:true,success:function(l){if(j.refreshsInProgress<=1){h.stop()}if(window.app.firstCall){window.app.updateNrOfUnreadConversations(false);window.app.firstCall=false}window.app.requestIndex++}})},gatherFilterOptions:function(){var n={};var m=[];if(this.filters.tagFilteringEnabled){m=this.filters.tagsForFiltering}var o=this.filters.starredFilteringEnabled;var i=this.filters.supportFilteringEnabled;var j=this.workingPoints.checkedPhoneNumbersArray;var k,p;if(this.filters.dateFilteringEnabled){k=this.filters.startDate;p=this.filters.endDate}var l=this.filters.unreadFilteringEnabled;var q=window.app.defaultNrOfConversationsToDisplay;var r=window.app.cummulativeSkip;n.onlyFavorites=o;n.tags=m;n.workingPointsNumbers=j;n.startDate=k;n.endDate=p;n.onlyUnread=l;n.skip=r;n.top=q;n.requestIndex=window.app.requestIndex;n.popUpSupport=i;return n},getAdditionalConversations:function(){var k=document.getElementById("loadMoreConversations");$(k).removeClass("readable");$(k).addClass("unreadable");b.spin(k);window.app.cummulativeSkip=this.convsList.length;var i=this.gatherFilterOptions();var j=this;$.ajax({url:"Conversations/ConversationsList",data:i,traditional:true,success:function(m,n,l){b.stop();$(k).removeClass("unreadable");$(k).addClass("readable");$.each(m,function(){var o=new window.app.Conversation({From:$(this).attr("From"),ConvID:$(this).attr("ConvID"),TimeReceived:$(this).attr("TimeReceived"),Text:$(this).attr("Text"),Read:$(this).attr("Read"),To:$(this).attr("To"),Starred:$(this).attr("Starred"),ClientDisplayName:$(this).attr("ClientDisplayName"),ClientIsSupportBot:$(this).attr("ClientIsSupportBot")});j.convsList.add(o,{silent:true});j.addConversationBasicEffect(o,false)});if(m.length===0||m.length<window.app.defaultNrOfConversationsToDisplay){$(k).hide("slow")}}})},render:function(){this._rendered=true;this.refreshsInProgress--;if(this.refreshsInProgress===0){var j=$("#conversations");j.html("");var i=this;this.convsList.each(function(k){i.addConversationBasicEffect(k)})}},addConversationWithEffect:function(l,k,j){if(k===null){k=true}if(j===null){j=false}var i=this.addConversationNoEffect(l,k);var m=500;if(j){if(l.ClientIsSupportBot){$(i).addClass("ui-selectedSupport")}else{$(i).addClass("ui-selected")}gSelectedElement=i;resetTimer();startTimer(3000)}$(i).hide().fadeIn(m)},addConversationBasicEffect:function(k,j){if(j===null){j=true}var i=this.addConversationNoEffect(k,j);$(i).hide().fadeIn("slow")},addConversationNoEffect:function(m,l){var j=new window.app.ConversationView({model:m});this._convViews.push(j);var k=j.render().el;if(l){$(this.el).prepend(k)}else{$(this.el).append(k)}var i=this;m.on("change",function(n){if(n.hasChanged("Read")&&n.get("Read")){}else{if(n.hasChanged("Starred")){}else{i.updateConversation(n)}}});if(this.convsList.models.length>=window.app.defaultNrOfConversationsToDisplay){$("#loadMoreConversations").show("slow")}return k},updateConversation:function(i){var j=this;var l=_(this._convViews).select(function(n){return n.model.get("ConvID")===i.get("ConvID")})[0];if(l!==undefined&&l!==null){this._convViews=_(this._convViews).without(l);if(this._rendered){var m=false;if(gSelectedElement===l.el){m=true}var k=$(l.el);k.fadeOut("slow",function(){k.remove();i.off("change");j.addConversationWithEffect(i,true,m)})}}},newMessageReceived:function(n,m,i,o,l,p,q){var j=a.convsView.convsList.get(i);if(j){j.set({Text:l},{silent:true});j.set({Read:p},{silent:true});j.set("To",m);j.set("From",n)}else{if(!a.convsView.filters.IsFilteringEnabled()){var k=new window.app.Conversation({From:n,To:m,ConvID:i,TimeReceived:o,Text:l,ClientDisplayName:n,ClientIsSupportBot:false,IsSmsBased:q});a.convsView.convsList.add(k);a.convsView.addConversationWithEffect(k,true,false)}}}});$("#loadMoreConversations").bind("click",function(i){a.convsView.getAdditionalConversations()});this.convsView=new c();$(document).bind("conversationSelected",function(i,j){a.convsView.convsList.get(j.convID)})};