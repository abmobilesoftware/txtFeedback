window.app=window.app||{};window.app.silentRemove=false;var tagsRep={};window.app.Tag=Backbone.Model.extend({defaults:{Name:"tag",Description:"description",TagType:"none",IsDefault:false},idAttribute:"Name"});window.app.TagsPool=Backbone.Collection.extend({model:window.app.Tag,url:function(){return"Tags/GetTagsForConversation"}});window.app.SpecialTagsPool=Backbone.Collection.extend({model:window.app.Tag,url:function(){return"Tags/GetSpecialTags"}});function TagsArea(){var d={lines:9,length:5,width:3,radius:3,rotate:0,color:"black",speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};var g=new Spinner(d);$("#thumbsUp").qtip({content:$("#thumbsUp").attr("tooltiptitle"),position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});$("#thumbsDown").qtip({content:$("#thumbsDown").attr("tooltiptitle"),position:{corner:{target:"leftMiddle",tooltip:"rightMiddle"}},style:"dark"});var c=$("#messagesAddTagPlaceHolderMessage").val();var e=$("#messagesRemoveTagPlaceHolderMessage").val();var a;var f=Backbone.View.extend({el:$("#tagsPool"),initialize:function(){a=this;this.conversationID="";window.app.removeTagTitle=e;$("#tags").tagsInput({height:"22px",width:"auto",onAddTag:this.onAddTag,onRemoveTag:this.onRemoveTag,autocomplete_url:"Tags/FindMatchingTags",defaultText:c,placeholder:c,interactve:true});this.thumbsUp=$("#thumbsUp");this.thumbsDown=$("#thumbsDown");this.specialTagsPool=new window.app.SpecialTagsPool();this.getSpecialTags();_.bindAll(this,"render","appendTag","onAddTag","onRemoveTag","getTags","getSpecialTags");$(".specialTag").click(function(){window.app.silentRemove=false;var j=$(this).attr("tagType");var h=a.specialTagsPool.where({TagType:j,IsDefault:true})[0];var i=h.get("Name");if(!$("#tags").tagExist(i)){$("#tags").addTag(i)}else{$("#tags").removeTag(i)}})},onAddTag:function(j){var h=new window.app.Tag({Name:j});tagsRep[gSelectedConversationID].add(h);$.getJSON("Tags/AddTagToConversations",{tagName:j,convID:gSelectedConversationID},function(k){});var i=a.specialTagsPool.where({Name:j,IsDefault:true})[0].get("TagType");a.toggleHands(i)},onRemoveTag:function(k){var h=tagsRep[gSelectedConversationID];var i=_(h.models).select(function(l){return l.get("Name")===k})[0];h.remove(i);$.getJSON("Tags/RemoveTagFromConversation",{tagName:k,convID:gSelectedConversationID},function(l){});var j=a.specialTagsPool.where({Name:k,IsDefault:true})[0].get("TagType");a.turnHandOff(j)},getTags:function(j){var h=$("#tags");h.importTags("");this.conversationID=j;if(j in tagsRep){g.stop();this.render()}else{var i=new window.app.TagsPool();i.bind("reset",this.render);i.fetch({data:{conversationID:j},success:function(){}});tagsRep[j]=i}},getSpecialTags:function(){this.specialTagsPool.fetch()},render:function(){var i=$("#tags");i.importTags("");var h=this;tagsRep[this.conversationID].each(function(j){h.appendTag(j)});this.turnHandsOff();this.turnTheHandOn("positiveFeedback",$("#thumbsUp"));this.turnTheHandOn("negativeFeedback",$("#thumbsDown"))},appendTag:function(h){$("#tags").addTag(h.get("Name"),{callback:false})},turnTheHandOn:function(j,i){var h=this.specialTagsPool.where({TagType:j,IsDefault:true})[0].get("Name");if($("#tags").tagExist(h)){$(i).css("background-position","24px 0")}},toggleHands:function(j){if(j==="positiveFeedback"){a.thumbsUp.css("background-position","24px 0");var l="negativeFeedback";var i=a.specialTagsPool.where({TagType:l,IsDefault:true})[0].get("Name");if($("#tags").tagExist(i)){a.sendEventToServer("pos");window.app.silentRemove=true;$("#tags").removeTag(i);window.app.silentRemove=false}else{a.sendEventToServer("pos")}}else{if(j==="negativeFeedback"){a.thumbsDown.css("background-position","24px 0");var h="positiveFeedback";var k=a.specialTagsPool.where({TagType:h,IsDefault:true})[0].get("Name");if($("#tags").tagExist(k)){a.sendEventToServer("neg");window.app.silentRemove=true;$("#tags").removeTag(k,true);window.app.silentRemove=false}else{a.sendEventToServer("neg")}}}},turnHandsOff:function(){a.thumbsUp.css("background-position","0 0");a.thumbsDown.css("background-position","0 0")},turnHandOff:function(h){if(!window.app.silentRemove){if(h==="positiveFeedback"){a.thumbsUp.css("background-position","0 0");a.sendEventToServer("neuter")}else{a.thumbsDown.css("background-position","0 0");a.sendEventToServer("neuter")}}else{if(h==="positiveFeedback"){a.thumbsUp.css("background-position","0 0")}else{a.thumbsDown.css("background-position","0 0")}}},sendEventToServer:function(h){$.getJSON("Messages/AddAnEventInConversationHistory",{conversationId:gSelectedConversationID,eventType:h},function(i){})}});var b=new f();return b};