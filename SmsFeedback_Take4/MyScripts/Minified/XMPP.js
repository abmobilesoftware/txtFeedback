"use strict";window.app=window.app||{};window.app.xmppConn={};window.app.receivedMsgID=12345;window.app.getFeaturesIQID="info14";window.app.addressOfPhpScripts="dragos@txtfeedback.net";window.app.selfXmppAddress="";function signalMsgReceivedAtServer(c,b,g,e,a,f,d){window.app.updateNrOfUnreadConversations(false)}window.app.setNrOfUnreadConversationOnTab=function(b){window.app.nrOfUnreadConvs=b;var a="("+b+")";$("#msgTabcount").text(a)};window.app.xmppHandlerInstance={};$(function(){window.app.xmppHandlerInstance=new window.app.XMPPhandler();$.getJSON(window.app.domainName+"/Xmpp/GetConnectionDetailsForLoggedInUser",function(a){if(a!==""){window.app.selfXmppAddress=a.XmppUser;window.app.xmppHandlerInstance.connect(window.app.selfXmppAddress,a.XmppPassword);window.app.updateNrOfUnreadConversations(true)}});$(document).bind("msgReceived",function(a,b){if(b.messageIsSent===undefined||(b.messageIsSent!==undefined&&!b.messageIsSent)){signalMsgReceivedAtServer(b.fromID,b.toID,b.convID,b.msgID,b.dateReceived,b.text,false)}})});window.app.handleIncommingMessage=function(c,d){var k;if(window.DOMParser){var a=new DOMParser();k=a.parseFromString(c,"text/xml")}else{k=new ActiveXObject("Microsoft.XMLDOM");k.async=false;k.loadXML(c)}var g=k.getElementsByTagName("msg")[0];var h=g.getElementsByTagName("from")[0].textContent;h=cleanupPhoneNumber(h);var f=g.getElementsByTagName("to")[0].textContent;f=cleanupPhoneNumber(f);var i=g.getElementsByTagName("datesent")[0].textContent;var b;if(d){b=buildConversationID(h,f)}else{b=buildConversationID(f,h)}var e=g.getElementsByTagName("body")[0].textContent;var j=false;window.app.receivedMsgID++;$(document).trigger("msgReceived",{fromID:h,toID:f,convID:b,msgID:window.app.receivedMsgID,dateReceived:i,text:e,readStatus:j})};window.app.XMPPhandler=function XMPPhandler(){this.userid=null;this.password=null;this.conn=null;this.connection=null;this.start_time=null;this.connectCallback=function(a){var c=false;if(a===Strophe.Status.CONNECTED){window.app.logDebugOnServer("XMPP connected");window.app.xmppConn.connection=window.app.xmppConn.conn;window.app.xmppConn.connection.addHandler(window.app.xmppConn.handle_infoquery,null,"iq",null,null);window.app.xmppConn.connection.addHandler(window.app.xmppConn.handle_message,null,"message",null,null);var b=Strophe.getDomainFromJid(window.app.xmppConn.connection.jid);window.app.xmppConn.send_initial_presence(b);window.app.xmppConn.getInfo(b)}else{if(a===Strophe.Status.CONNECTING){window.app.logDebugOnServer("XMPP connecting...")}else{if(a===Strophe.Status.AUTHENTICATING){window.app.logDebugOnServer("XMPP authenticating...")}else{if(a===Strophe.Status.DISCONNECTED){window.app.logDebugOnServer("XMPP disconnected");c=true}else{if(a===Strophe.Status.CONNFAIL){window.app.logDebugOnServer("XMPP connection fail");window.app.xmppConn.conn.disconnect()}else{if(a===Strophe.Status.AUTHFAIL){window.app.logDebugOnServer("XMPP authentication failed");window.app.xmppConn.conn.disconnect()}else{if(a===Strophe.Status.ERROR){window.app.logDebugOnServer("XMPP status error");window.app.xmppConn.conn.disconnect()}}}}}}}if(c){window.app.xmppConn.connect(window.app.xmppConn.userid,window.app.xmppConn.password,window.app.xmppConn.connectCallback)}};this.connect=function(b,c){var a=this;var d="http://176.34.122.48:5280/http-bind/";a.conn=new Strophe.Connection(d);a.userid=b;a.password=c;window.app.xmppConn=this;a.conn.connect(b,c,a.connectCallback)};this.disconnect=function(){var a=this;a.conn.disconnect()};this.send_ping=function(b){var a=$iq({to:b,type:"get",id:"ping1"}).c("ping",{xmlns:"urn:xmpp:ping"});this.start_time=(new Date()).getTime();this.connection.send(a)};this.send_initial_presence=function(b){var a=$pres().c("status").t("Ready or not");this.connection.send(a)};this.enableCarbons=function(b){var a=$iq({type:"set",id:"enableCarbons"}).c("enable",{xmlns:"urn:xmpp:carbons:1"});this.connection.send(a)};this.getInfo=function(b){var a=$iq({to:b,type:"get",id:window.app.getFeaturesIQID}).c("query",{xmlns:"http://jabber.org/protocol/disco#info"});this.connection.send(a)};this.send_reply=function(g,f,a,c,b){var e="<msg> <from>"+g+"</from> <to>"+f+"</to> <datesent>"+a+"</datesent> <body>"+c+"</body> </msg>";var d=$msg({from:window.app.selfXmppAddress,to:b,type:"chat"}).c("body").t(e);this.connection.send(d)};this.handle_infoquery=function(b){var a=(new Date()).getTime()-this.start_time;var c=$(b);if(c.attr("id")===window.app.getFeaturesIQID){window.app.xmppConn.enableCarbons(c.attr("from"))}if(c.attr("type")==="result"){}if(c.attr("type")==="error"){}return true};this.handle_message=function(e){if($(e).attr("type")==="getConversationsResponse"){window.app.logDebugOnServer("XMPP Conversations list reponse received")}else{if($(e).attr("type")==="sendSmsResponse"){if($(e).children("body").text()==="error"){$("#quick_replay_text").val("")}else{this.displayConversationsList(e);$("#quick_replay_text").val("")}}else{if($(e).attr("type")==="getMessagesForConversationResponse"){var d=$(e).children("body").text();this.displayMessagesForConversation(d)}else{if($(e).attr("type")==="result"){var b=$(e).children("body").text()}else{if($(e).attr("type")==="chat"){if($(e).children("sent").attr("xmlns")==="urn:xmpp:carbons:1"){if(e.getElementsByTagName("body")!=undefined&&e.getElementsByTagName("body").length!==0){var a=Strophe.getText(e.getElementsByTagName("body")[0]);window.app.handleIncommingMessage(a,false)}}else{var c=Strophe.getText(e.getElementsByTagName("body")[0]);window.app.handleIncommingMessage(c,true)}}else{}}}}}return true}};