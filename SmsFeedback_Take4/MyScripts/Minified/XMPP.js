"use strict";window.app=window.app||{};window.app.xmppConn={};window.app.receivedMsgID=12345;function signalMsgReceivedAtServer(c,b,g,e,a,f,d){console.log("signalMsgReceivedAtServer");$.getJSON("Messages/MessageReceived",{from:c,to:b,text:f,convId:g,receivedTime:a,readStatus:d},function(h){console.log(h);app.updateNrOfUnreadConversations(false)})}window.app.setNrOfUnreadConversationOnTab=function(b){console.log("unread conversations: "+b);app.nrOfUnreadConvs=b;var a="("+b+")";$("#msgTabcount").text(a)};window.app.xmppHandlerInstance={};$(function(){app.xmppHandlerInstance=new app.XMPPhandler();$.getJSON(app.domainName+"/Xmpp/GetConnectionDetailsForLoggedInUser",function(a){if(a!==""){app.xmppHandlerInstance.connect(a.XmppUser,a.XmppPassword);app.updateNrOfUnreadConversations(true)}});$(document).bind("msgReceived",function(a,b){if(b.messageIsSent===undefined||(b.messageIsSent!==undefined&&!b.messageIsSent)){signalMsgReceivedAtServer(b.fromID,b.toID,b.convID,b.msgID,b.dateReceived,b.text,false)}})});window.app.XMPPhandler=function XMPPhandler(){console.log("Constructor called");this.userid=null;this.password=null;this.conn=null;this.connection=null;this.start_time=null;this.connectCallback=function(a){var c=false;if(a===Strophe.Status.CONNECTED){showStatus("XMPP connected",5000);console.log("CONNECTED");app.xmppConn.connection=app.xmppConn.conn;app.xmppConn.connection.addHandler(app.xmppConn.handle_infoquery,null,"iq",null,"ping1");app.xmppConn.connection.addHandler(app.xmppConn.handle_message,null,"message",null,null);var b=Strophe.getDomainFromJid(app.xmppConn.connection.jid);app.xmppConn.send_ping(b);app.xmppConn.send_initial_presence(b)}else{if(a===Strophe.Status.CONNECTING){showStatus("XMPP CONNECTING",5000);console.log("CONNECTING")}else{if(a===Strophe.Status.AUTHENTICATING){showStatus("XMPP AUTHENTICATING",5000);console.log("AUTHENTICATING")}else{if(a===Strophe.Status.DISCONNECTED){showStatus("XMPP DISCONNECTED",5000);console.log("DISCONNECTED");c=true}else{if(a===Strophe.Status.CONNFAIL){showStatus("XMPP CONNFAILED",5000);console.log("CONNFAILED");c=true}else{if(a===Strophe.Status.AUTHFAIL){showStatus("XMPP AUTHFAIL",5000);console.log("AUTHFAIL");c=true}else{if(a===Strophe.Status.ERROR){showStatus("XMPP ERROR",5000);console.log("ERROR");c=true}}}}}}}if(c){app.xmppConn.connect(app.xmppConn.userid,app.xmppConn.password,app.xmppConn.connectCallback)}};this.connect=function(b,c){var a=this;var d="http://176.34.122.48:7070/http-bind/";a.conn=new Strophe.Connection(d);a.userid=b;a.password=c;window.app.xmppConn=this;a.conn.connect(b,c,a.connectCallback)};this.disconnect=function(){var a=this;a.conn.disconnect()};this.log=function(a){console.log(a)};this.send_ping=function(b){var a=$iq({to:b,type:"get",id:"ping1"}).c("ping",{xmlns:"urn:xmpp:ping"});this.log("Sending ping to "+b+".");this.start_time=(new Date()).getTime();this.connection.send(a)};this.send_initial_presence=function(b){var a=$pres().c("status").t("Ready or not");this.connection.send(a);this.log("Initial presence sent")};this.send_reply=function(e,d,a){var c=Strophe.xmlescape("<sms> <sms_from>"+e+"</sms_from> <sms_to>"+d+"</sms_to> <sms_body>"+a+"</sms_body> </sms>");var b=$msg({to:"logic.smsfeedback.com",from:"smsapp@smsfeedback.com",type:"sendSmsRequest"}).c("body").t(c);this.connection.send(b);this.log("Reply sent")};this.handle_infoquery=function(c){var a=(new Date()).getTime()-this.start_time;console.log("Received pong from server in "+a+"ms");var b=$iq({to:$(c).attr("from"),from:$(c).attr("to"),type:"result",id:$(c).attr("id")});if($(c).children("ping")!=null){app.xmppConn.connection.send(b)}return false};this.handle_message=function(k){console.log(k);if($(k).attr("type")==="getConversationsResponse"){this.log("Conversations list reponse received")}else{if($(k).attr("type")==="sendSmsResponse"){if($(k).children("body").text()==="error"){this.log("SMS send failed!!!");$("#quick_replay_text").val("")}else{this.displayConversationsList(k);$("#quick_replay_text").val("")}}else{if($(k).attr("type")==="getMessagesForConversationResponse"){var d=$(k).children("body").text();this.displayMessagesForConversation(d);this.log("Messages for conversation retrieved!")}else{var c=(Strophe.getText(k.getElementsByTagName("body")[0]));var j;if(window.DOMParser){var a=new DOMParser();j=a.parseFromString(c,"text/xml")}else{j=new ActiveXObject("Microsoft.XMLDOM");j.async=false;j.loadXML(c)}var g=j.getElementsByTagName("msg")[0];var h=g.getElementsByTagName("from")[0].textContent;h=cleanupPhoneNumber(h);var f=g.getElementsByTagName("to")[0].textContent;f=cleanupPhoneNumber(f);var i=g.getElementsByTagName("datesent")[0].textContent;var b=buildConversationID(h,f);var e=g.getElementsByTagName("body")[0].textContent;$(document).trigger("msgReceived",{fromID:h,toID:f,convID:b,msgID:app.receivedMsgID,dateReceived:i,text:e,readStatus:false});app.receivedMsgID++}}}return true}};