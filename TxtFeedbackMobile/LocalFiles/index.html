<!DOCTYPE html>
<!--
* @file index.html
*
* Template application that shows examples of how to access
* device services from JavaScript using the Wormhole library.
-->
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Wormhole Template App</title>
		<!-- <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.css" />-->
		<link rel="stylesheet" href="css/jquery.mobile-1.3.1.css" />
		<link rel="stylesheet" href="css/messages.css" />
		<link rel="stylesheet" href="css/conversations.css" />
		<link rel="stylesheet" href="css/logon.css" />
		<link rel="stylesheet" href="css/app.css" />
		<script type="text/javascript" charset="utf-8" src="js/scripts/jquery-1.8.2.js"></script>
		<!-- Jquery ui contains only datepicker functionality -->
		<script type="text/javascript" charset="utf-8" src="js/scripts/jquery-ui-1.10.2.custom.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/scripts/underscore.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/scripts/backbone.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/scripts/strophe.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/myScripts/Utilities.js"></script>		
		<script type="text/template" id="conversation-template">
		<a href="#">	
			<% var customer = getFromToFromConversation(ConvID)[0];
			   var fromParsed = IsSmsBased ? cleanupPhoneNumber(From) : 
					extractUser(From);
			   if (customer == fromParsed) {
			 %>			
				<img class="conversation-thumb" src="images/Inbox-blue-32.png" alt="inbox" />
			<% 
				} else {
			%>
				<img class="conversation-thumb" src="images/Outbox-green-32.png" alt="outbox" />
			<% } %>
			<p class="conversation-actors"><%= ClientDisplayName  %>... >> <%= WorkingPointDisplayName %></p>			
			<span class="conversation-last-message"><%= Text %></span>						
		</a>
		</script>
		<script type="text/template" id="message-template">
			<% var customer = getFromToFromConversation(ConvID)[0];
			   var fromParsed = IsSmsBased ? cleanupPhoneNumber(From) : 
					extractUser(From);
			%>
			<p class="message"><%= Text %></p>
			<% 
				//messageDate[0] is time
				var messageDate = TimeReceived.toTimeString().split(" ");
				var enFormat = "DD, MM d, yy";
			%>
			<div class="info">
				<p class="timeReceived"><%= $.datepicker.formatDate(enFormat, TimeReceived) + " " + messageDate[0] %></p>
					<% if (fromParsed != customer && !CarbonsMessage) { %>
						<div class="acknowledge">
							<% if (ServerAcknowledge) { 
									if (ClientAcknowledge) { %>
									<img src="images/doubleCheck.png" alt="Message received by customer" />
							 	<% } else { %>
									<img src="images/singleCheck.png" alt="Message arrived on the Txtfeedback server" />
							<% 		}
								} %>
						</div>
					<% } %>
			</div>
		</script>
		<script type="text/template" id="listDivider-template">
			<% 
			   var enFormat = "DD, MM d, yy";
			   var today = new Date();
			   var yesterday = new Date();
			   yesterday.setDate(yesterday.getDate() - 1);
			   var dateToDisplay = GroupDate.toDateString() == today.toDateString() ? "Today" 
									: GroupDate.toDateString() == yesterday.toDateString() ? "Yesterday" 
									: $.datepicker.formatDate(enFormat, GroupDate)

			%>
			<span class="groupDate"><%= dateToDisplay %></span> 
			<span class="ui-li-count ui-btn-up-c ui-btn-corner-all"><%= ConversationsCount %></span>
		</script>
		<script type="text/javascript" charset="utf-8" src="js/myScripts/LogOn.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/myScripts/WorkingPoints.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/myScripts/Conversations.js"></script>  
		<script type="text/javascript" charset="utf-8" src="js/myScripts/Messages.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/myScripts/App.js"></script>  
     	<script type="text/javascript" charset="utf-8" src="js/scripts/wormhole.js"></script>	
     			
		<script type="text/javascript">
			// The "deviceready" event is sent when the system
			// has finished loading.
			function pushNotificationDidRegistered(token) {
				//document.getElementById("regStatus").innerHTML = "REGISTERED " + token;
				storage.setItem("GCMKey", token);		
				
			};
			
			function pushNotificationFailedToRegister(error) {
				//document.getElementById("regStatus").innerHTML = "Error " + error.message;
			}
			
			function processNotification(notification) {
				//document.getElementById("pushNotification").innerHTML = "Mesaj primit " + notification.message;
			};
			
			function registerPhoneInGCM() {
				//document.getElementById("regStatus").innerHTML = "REGISTERING";
				pushNotificationManager.register(
						pushNotificationDidRegistered,
						pushNotificationFailedToRegister);
			}
			
			function listenForGCMNotifications() {
				//document.getElementById("regStatus").innerHTML = "Registered. Listening";
				pushNotificationManager.listener(
						processNotification);
			}
			
			function startApp() {
				var app = new AppView({el: $("body")});				
			}
			
			var pushNotificationManager;
			var storage;
			function deviceReady() {
				console.log("Start");
				storage = window.localStorage;
				pushNotificationManager = new PushNotificationManager();
				pushNotificationManager.accountID("92320531700");
				if (storage.getItem("GCMKey") == null) {
					console.log("cheia nu exista. inregistrare");
					registerPhoneInGCM();					
				} else {
					console.log("cheia exista. ascult dupa notificari");
					listenForGCMNotifications();		
					
				};					
			};			
			$(document).ready(startApp);
			
			document.addEventListener("deviceready",
					deviceReady,
					true);
			
		</script>
		<!--<script src="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.js"></script>-->
		<script type="text/javascript" charset="UTF-8" src="js/scripts/jquery.mobile-1.3.1.js"></script>
		
	</head>
	<body>
		<div id="logOnPage" data-role="page">
			<!-- DEV http://www.dev.txtfeedback.net/Account/AjaxLogOn -->
			<!-- LOCAL DEBUG: In VS2012 Project -> Web -> Use Visual Studio Development Server -->
			<!-- EMULATOR http://10.0.2.2:4631/Account/AjaxLogOn -->
			<!-- BROWSER http://localhost:4631/Account/AjaxLogOn -->
			<div data-role="content">
				<div id="logo">
					<img src="images/logo.png" alt="Welcome to Txtfeedback!" />
				</div>
				<form id="logOnForm" data-ajax="false" action="http://www.dev.txtfeedback.net/Account/AjaxLogOn" method="POST">
					<label for="username" class="ui-hidden-accessible">Username</label>
					<input type="text" name="username" id="username" placeholder="Username"/>
					<label for="password" class="ui-hidden-accessible">Password</label>
					<input type="password" name="password" id="password" placeholder="Password"/><br/>
					<input type="submit" id="logOnBtn" data-theme="b" value="Login"/> 
				</form>
			</div>			
		</div>
		<div id="conversationsPage" data-role="page">
			<div data-role="header" class="app-header" data-position="fixed" data-id="persistentHeader">
				<h1>Conversations</h1>
				<a href="#" id="logOffBtn" class="ui-btn-right" data-theme="b">LogOff</a>
			</div>
			<div data-role="content">
				<ul id="convList" data-role="listview" data-theme="d">					
				</ul>
			</div>				
		</div>
		<div id="messagesPage" data-role="page">
			<div data-role="header" class="app-header" data-position="fixed" data-id="persistentHeader">
				<h1>Messages</h1>
			</div>
			<div data-role="content">
				<ul id="messagesList" data-role="listview">
				
				</ul>
			</div>
			<div class="app-footer msg-footer" data-role="footer" data-position="fixed">
				<textarea id="sendMsgTextArea"></textarea>
				<button type="button" id="sendMsgBtn" data-theme="b">Send</button>
			</div>
		</div>
	</body>
</html>
